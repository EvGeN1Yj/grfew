name: Build, Push to Private Registry and Deploy with Helm

on:
  push:
    branches: [ main ]

env:
  REGISTRY: "77.232.36.136:30500"  # Замените на ваш IP
  IMAGE_NAME: "django-app"
  K8S_NAMESPACE: "django-app"
  HELM_RELEASE: "django-app-production"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install skopeo for insecure registry
      run: |
        # Устанавливаем skopeo для работы с insecure registry
        sudo apt-get update
        sudo apt-get install -y skopeo

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./django-kubernetes-app
        platforms: linux/amd64
        push: false
        load: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=inline

    - name: Push to insecure registry using skopeo
      run: |
        # Используем skopeo для push в insecure HTTP registry
        REGISTRY="${{ env.REGISTRY }}"
        IMAGE_NAME="${{ env.IMAGE_NAME }}"
        SHA="${{ github.sha }}"

        # Сохраняем образ в tar
        docker save ${REGISTRY}/${IMAGE_NAME}:latest > /tmp/image-latest.tar
        docker save ${REGISTRY}/${IMAGE_NAME}:${SHA} > /tmp/image-sha.tar

        # Пушим через skopeo с insecure опцией
        skopeo copy --dest-tls-verify=false \
          docker-archive:/tmp/image-latest.tar \
          docker://${REGISTRY}/${IMAGE_NAME}:latest \
          --dest-creds=admin:"${{ secrets.REGISTRY_PASSWORD }}"

        skopeo copy --dest-tls-verify=false \
          docker-archive:/tmp/image-sha.tar \
          docker://${REGISTRY}/${IMAGE_NAME}:${SHA} \
          --dest-creds=admin:"${{ secrets.REGISTRY_PASSWORD }}"

        # Очищаем временные файлы
        rm -f /tmp/image-*.tar

  deploy-with-helm:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: "3.12.0"

    - name: Set up Kubeconfig
      uses: azure/k8s-set-context@v3
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG }}

    - name: Add Helm repositories
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update

    - name: Deploy with Helm
      run: |
        cd django-app-chart
        helm dependency update || helm dependency build
        helm upgrade --install ${{ env.HELM_RELEASE }} . \
          --namespace ${{ env.K8S_NAMESPACE }} \
          --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
          --set image.tag=latest \
          --set app.replicas=3 \
          --set imagePullSecrets=registry-secret \
          --create-namespace \
          --wait \
          --timeout 300s

        helm list --namespace ${{ env.K8S_NAMESPACE }}
        kubectl get pods,svc -n ${{ env.K8S_NAMESPACE }}

    - name: Run database migrations
      run: |
        POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l "app.kubernetes.io/name=django-app" -o jsonpath='{.items[0].metadata.name}')
        if [ -n "$POD_NAME" ]; then
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py migrate
          kubectl exec -n ${{ env.K8S_NAMESPACE }} $POD_NAME -- python manage.py collectstatic --noinput
        else
          echo "Pod not found, skipping migrations"
        fi


